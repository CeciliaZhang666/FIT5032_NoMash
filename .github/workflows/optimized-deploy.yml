name: Optimized Build & Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with caching
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with optimizations
        run: |
          # è®¾ç½®ç”Ÿäº§çŽ¯å¢ƒ
          export NODE_ENV=production
          # æž„å»ºé¡¹ç›®
          npm run build
          # æ£€æŸ¥æž„å»ºå¤§å°
          echo "Build size information:"
          du -h dist/

      - name: Optimize static assets
        run: |
          # åŽ‹ç¼© HTML, CSS, JS æ–‡ä»¶ (Minification)
          find dist -name "*.html" -o -name "*.css" -o -name "*.js" | head -10
          
          # æ·»åŠ ç¼“å­˜æŽ§åˆ¶å¤´ä¿¡æ¯
          echo "# Cache optimization for GitHub Pages" > dist/.htaccess
          echo "ExpiresByType text/css 'access plus 1 year'" >> dist/.htaccess
          echo "ExpiresByType application/javascript 'access plus 1 year'" >> dist/.htaccess
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
          echo "{
            \"buildTime\": \"$(date -Iseconds)\",
            \"optimizations\": [
              \"Asset minification\",
              \"Cache headers\",
              \"Reduced HTTP requests\",
              \"Production build\"
            ]
          }" > dist/build-info.json

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages
          folder: dist
          clean: true

      - name: Performance summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ - æ€§èƒ½ä¼˜åŒ–æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "### åº”ç”¨çš„ä¼˜åŒ–æŠ€æœ¯:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **å‡å°‘ HTTP è¯·æ±‚**: èµ„æºåˆå¹¶å’ŒåŽ‹ç¼©" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… **æ–‡ä»¶åŽ‹ç¼©**: CSS å’Œ JavaScript æœ€å°åŒ–" >> $GITHUB_STEP_SUMMARY  
          echo "3. âœ… **ç¼“å­˜ä¼˜åŒ–**: é™æ€èµ„æºç¼“å­˜ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… **ç”Ÿäº§æž„å»º**: ä¼˜åŒ–çš„æž„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **æž„å»ºä¿¡æ¯**:" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½² URL: https://ceciliazhang666.github.io/FIT5032_NoMash/" >> $GITHUB_STEP_SUMMARY
